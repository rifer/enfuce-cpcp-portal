name: Run EVALS on Deployment

on:
  # Run on successful deployments
  deployment_status:

  # Allow manual trigger with custom URL
  workflow_dispatch:
    inputs:
      api_url:
        description: 'API URL to test against'
        required: true
        default: ''
      ai_provider:
        description: 'AI provider to use (local/anthropic/openai)'
        required: false
        default: 'local'

jobs:
  run-evals:
    name: Run Conversational Wizard EVALS
    runs-on: ubuntu-latest
    # Only run on successful deployments or manual trigger
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Wait for deployment (if triggered by deployment)
        if: github.event_name == 'deployment_status'
        run: |
          echo "Waiting for deployment to be ready..."
          echo "Target URL: ${{ github.event.deployment_status.target_url }}"

          # Wait up to 2 minutes for deployment to be ready
          for i in {1..12}; do
            echo "Attempt $i/12..."
            # Check if we can connect (any HTTP response means deployed)
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ github.event.deployment_status.target_url }}" || echo "000")
            echo "  Response: $HTTP_CODE"

            # Any 2xx, 3xx, 4xx response means the site is deployed and responding
            # Only fail on 000 (connection failed) or 5xx (server error)
            if [ "$HTTP_CODE" != "000" ] && [ "$HTTP_CODE" -lt 500 ]; then
              echo "‚úì Deployment is ready! (HTTP $HTTP_CODE)"
              break
            fi

            if [ $i -eq 12 ]; then
              echo "‚ö†Ô∏è Deployment check timed out, but continuing anyway..."
            else
              echo "  Deployment not ready yet, waiting 10 seconds..."
              sleep 10
            fi
          done

      - name: Determine API URL
        id: api_url
        run: |
          if [ "${{ github.event_name }}" == "deployment_status" ]; then
            URL="${{ github.event.deployment_status.target_url }}"
            echo "url=${URL}" >> $GITHUB_OUTPUT
            echo "Using deployment URL: ${URL}"
          elif [ -n "${{ github.event.inputs.api_url }}" ]; then
            URL="${{ github.event.inputs.api_url }}"
            echo "url=${URL}" >> $GITHUB_OUTPUT
            echo "Using manual URL: ${URL}"
          elif [ -n "${{ secrets.VERCEL_URL }}" ]; then
            URL="${{ secrets.VERCEL_URL }}"
            echo "url=${URL}" >> $GITHUB_OUTPUT
            echo "Using Vercel URL from secret: ${URL}"
          else
            echo "‚ö†Ô∏è No API URL configured, using localhost"
            echo "url=http://localhost:5173" >> $GITHUB_OUTPUT
          fi

      - name: Run EVALS - Local Provider
        env:
          API_URL: ${{ steps.api_url.outputs.url }}
          AI_PROVIDER: local
        run: |
          echo "üß™ Running EVALS (LOCAL) against: $API_URL"
          npm run evals:local

      - name: Run EVALS - Anthropic Provider
        env:
          API_URL: ${{ steps.api_url.outputs.url }}
          AI_PROVIDER: anthropic
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "üß™ Running EVALS (ANTHROPIC) against: $API_URL"
          npm run evals:anthropic

      - name: Upload EVALS results - Local
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evals-results-local
          path: |
            evals/results/latest-local.json
            evals/failures/failures-local.txt
            evals/failures/failures-local.json
          retention-days: 30
          if-no-files-found: warn

      - name: Upload EVALS results - Anthropic
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evals-results-anthropic
          path: |
            evals/results/latest-anthropic.json
            evals/failures/failures-anthropic.txt
            evals/failures/failures-anthropic.json
          retention-days: 30
          if-no-files-found: warn

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const localPath = 'evals/results/latest-local.json';
            const anthropicPath = 'evals/results/latest-anthropic.json';

            // Check if results files exist
            const localExists = fs.existsSync(localPath);
            const anthropicExists = fs.existsSync(anthropicPath);

            if (!localExists && !anthropicExists) {
              const body = `## üß™ EVALS Results

              ‚ö†Ô∏è **EVALS did not complete successfully**

              Neither local nor anthropic tests generated results.
              Check the workflow logs for details.`;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
              return;
            }

            let body = `## üß™ EVALS Results (Dual-Provider)\n\n`;

            // Local provider results
            if (localExists) {
              const local = JSON.parse(fs.readFileSync(localPath, 'utf8'));
              body += '### üîµ Local Provider\n';
              body += `**Overall:** ${local.passed}/${local.total} tests passed (${local.metrics.validation_accuracy.toFixed(1)}%)\n\n`;
              body += '**Metrics:**\n';
              body += `- ‚è±Ô∏è Avg Response Time: ${local.metrics.avg_response_time.toFixed(0)}ms\n`;
              body += `- üî§ Typo Correction: ${local.metrics.typo_correction_rate.toFixed(1)}%\n`;
              body += `- ‚å®Ô∏è Command Recognition: ${local.metrics.command_recognition_rate.toFixed(1)}%\n`;
              body += `- üó£Ô∏è Natural Language: ${local.metrics.natural_language_understanding.toFixed(1)}%\n\n`;
              body += local.failed > 0 ? `‚ö†Ô∏è **${local.failed} tests failed** - Check artifacts for failures-local.txt\n\n` : '‚úÖ All tests passed!\n\n';
            } else {
              body += '### üîµ Local Provider\n‚ö†Ô∏è Tests did not complete\n\n';
            }

            // Anthropic provider results
            if (anthropicExists) {
              const anthropic = JSON.parse(fs.readFileSync(anthropicPath, 'utf8'));
              body += '### üü¢ Anthropic Provider\n';
              body += `**Overall:** ${anthropic.passed}/${anthropic.total} tests passed (${anthropic.metrics.validation_accuracy.toFixed(1)}%)\n\n`;
              body += '**Metrics:**\n';
              body += `- ‚è±Ô∏è Avg Response Time: ${anthropic.metrics.avg_response_time.toFixed(0)}ms\n`;
              body += `- üî§ Typo Correction: ${anthropic.metrics.typo_correction_rate.toFixed(1)}%\n`;
              body += `- ‚å®Ô∏è Command Recognition: ${anthropic.metrics.command_recognition_rate.toFixed(1)}%\n`;
              body += `- üó£Ô∏è Natural Language: ${anthropic.metrics.natural_language_understanding.toFixed(1)}%\n\n`;
              body += anthropic.failed > 0 ? `‚ö†Ô∏è **${anthropic.failed} tests failed** - Check artifacts for failures-anthropic.txt\n` : '‚úÖ All tests passed!\n';
            } else {
              body += '### üü¢ Anthropic Provider\n‚ö†Ô∏è Tests did not complete\n';
            }

            body += `\n---\nüì¶ Download detailed failure reports from workflow artifacts`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail if accuracy below threshold
        if: always()
        run: |
          LOCAL_FILE="evals/results/latest-local.json"
          ANTHROPIC_FILE="evals/results/latest-anthropic.json"
          THRESHOLD=85
          FAILED=0

          echo "==================================================================================="
          echo "Checking EVALS accuracy for both providers (threshold: ${THRESHOLD}%)"
          echo "==================================================================================="

          # Check local provider
          if [ -f "$LOCAL_FILE" ]; then
            LOCAL_ACCURACY=$(node -e "
              const fs = require('fs');
              const results = JSON.parse(fs.readFileSync('$LOCAL_FILE', 'utf8'));
              console.log(results.metrics.validation_accuracy);
            ")
            echo ""
            echo "üîµ LOCAL Provider Accuracy: $LOCAL_ACCURACY%"

            if (( $(echo "$LOCAL_ACCURACY < $THRESHOLD" | bc -l) )); then
              echo "   ‚ùå Below threshold (${THRESHOLD}%)"
              FAILED=1
            else
              echo "   ‚úÖ Meets threshold"
            fi
          else
            echo "‚ùå Local results file not found"
            FAILED=1
          fi

          # Check anthropic provider
          if [ -f "$ANTHROPIC_FILE" ]; then
            ANTHROPIC_ACCURACY=$(node -e "
              const fs = require('fs');
              const results = JSON.parse(fs.readFileSync('$ANTHROPIC_FILE', 'utf8'));
              console.log(results.metrics.validation_accuracy);
            ")
            echo ""
            echo "üü¢ ANTHROPIC Provider Accuracy: $ANTHROPIC_ACCURACY%"

            if (( $(echo "$ANTHROPIC_ACCURACY < $THRESHOLD" | bc -l) )); then
              echo "   ‚ùå Below threshold (${THRESHOLD}%)"
              FAILED=1
            else
              echo "   ‚úÖ Meets threshold"
            fi
          else
            echo "‚ùå Anthropic results file not found"
            FAILED=1
          fi

          echo ""
          echo "==================================================================================="

          if [ $FAILED -eq 1 ]; then
            echo "‚ùå One or more providers failed to meet accuracy threshold"
            echo "üì¶ Download failure reports from artifacts for details"
            exit 1
          else
            echo "‚úÖ Both providers meet accuracy threshold!"
            exit 0
          fi
