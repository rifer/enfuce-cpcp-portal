name: Run EVALS on Deployment

on:
  # Run on every deployment
  deployment_status:

  # Run on pull requests
  pull_request:
    branches: [ main, master ]

  # Run on push to main
  push:
    branches: [ main, master ]

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      api_url:
        description: 'API URL to test against'
        required: false
        default: ''
      ai_provider:
        description: 'AI provider to use (local/anthropic/openai)'
        required: false
        default: 'local'

jobs:
  run-evals:
    name: Run Conversational Wizard EVALS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Wait for deployment (if triggered by deployment)
        if: github.event_name == 'deployment_status'
        run: |
          echo "Waiting for deployment to be ready..."
          echo "Target URL: ${{ github.event.deployment_status.target_url }}"

          # Wait up to 2 minutes for deployment to be ready
          for i in {1..12}; do
            echo "Attempt $i/12..."
            if curl -sf "${{ github.event.deployment_status.target_url }}" > /dev/null; then
              echo "‚úì Deployment is ready!"
              break
            fi
            echo "Deployment not ready yet, waiting 10 seconds..."
            sleep 10
          done

      - name: Determine API URL
        id: api_url
        run: |
          if [ "${{ github.event_name }}" == "deployment_status" ]; then
            URL="${{ github.event.deployment_status.target_url }}"
            echo "url=${URL}" >> $GITHUB_OUTPUT
            echo "Using deployment URL: ${URL}"
          elif [ -n "${{ github.event.inputs.api_url }}" ]; then
            URL="${{ github.event.inputs.api_url }}"
            echo "url=${URL}" >> $GITHUB_OUTPUT
            echo "Using manual URL: ${URL}"
          elif [ -n "${{ secrets.VERCEL_URL }}" ]; then
            URL="${{ secrets.VERCEL_URL }}"
            echo "url=${URL}" >> $GITHUB_OUTPUT
            echo "Using Vercel URL from secret: ${URL}"
          else
            echo "‚ö†Ô∏è No API URL configured, using localhost"
            echo "url=http://localhost:5173" >> $GITHUB_OUTPUT
          fi

      - name: Run EVALS
        env:
          API_URL: ${{ steps.api_url.outputs.url }}
          AI_PROVIDER: ${{ github.event.inputs.ai_provider || 'local' }}
        run: |
          echo "üß™ Running EVALS against: $API_URL"
          echo "ü§ñ AI Provider: $AI_PROVIDER"
          npm run evals

      - name: Upload EVALS results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evals-results
          path: evals/results/latest.json
          retention-days: 30
          if-no-files-found: warn

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const resultsPath = 'evals/results/latest.json';

            // Check if results file exists
            if (!fs.existsSync(resultsPath)) {
              const body = `## üß™ EVALS Results

              ‚ö†Ô∏è **EVALS did not complete successfully**

              The EVALS test suite failed to run or did not generate results.
              This could be due to:
              - API not being available yet
              - Network connectivity issues
              - EVALS script error

              Check the workflow logs for details.`;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
              return;
            }

            const results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));

            const body = `## üß™ EVALS Results

            **Overall:** ${results.passed}/${results.total} tests passed (${results.metrics.validation_accuracy.toFixed(1)}%)

            ### Metrics
            - ‚è±Ô∏è Avg Response Time: ${results.metrics.avg_response_time.toFixed(0)}ms
            - üî§ Typo Correction: ${results.metrics.typo_correction_rate.toFixed(1)}%
            - ‚å®Ô∏è Command Recognition: ${results.metrics.command_recognition_rate.toFixed(1)}%
            - üó£Ô∏è Natural Language: ${results.metrics.natural_language_understanding.toFixed(1)}%

            ### By Category
            ${Object.entries(results.by_category).map(([cat, stats]) =>
              `- ${cat}: ${stats.passed}/${stats.total} (${((stats.passed/stats.total)*100).toFixed(0)}%)`
            ).join('\n')}

            ${results.failed > 0 ? '‚ö†Ô∏è Some tests failed. Check the artifacts for details.' : '‚úÖ All tests passed!'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail if accuracy below threshold
        if: always()
        run: |
          RESULTS_FILE="evals/results/latest.json"

          # Check if results file exists
          if [ ! -f "$RESULTS_FILE" ]; then
            echo "‚ùå EVALS results file not found at $RESULTS_FILE"
            echo "This likely means the EVALS did not complete successfully."
            echo "Check the 'Run EVALS' step logs for errors."
            exit 1
          fi

          ACCURACY=$(node -e "
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('$RESULTS_FILE', 'utf8'));
            console.log(results.metrics.validation_accuracy);
          ")

          echo "Validation Accuracy: $ACCURACY%"

          if (( $(echo "$ACCURACY < 85" | bc -l) )); then
            echo "‚ùå EVALS accuracy ($ACCURACY%) is below threshold (85%)"
            exit 1
          else
            echo "‚úÖ EVALS accuracy ($ACCURACY%) meets threshold"
          fi
